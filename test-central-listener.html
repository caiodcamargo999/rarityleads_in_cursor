<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Central Listener Test - Rarity Leads</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            max-width: 900px;
            margin: 0 auto;
            padding: 20px;
            background: #f8fafc;
        }
        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a202c;
            margin-bottom: 16px;
        }
        .test-button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 8px 8px 8px 0;
            font-size: 14px;
        }
        .test-button:hover {
            background: #5a67d8;
        }
        .test-button.google {
            background: #4285f4;
        }
        .test-button.google:hover {
            background: #3367d6;
        }
        .log-output {
            background: #1a202c;
            color: #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-top: 16px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            margin-left: 8px;
        }
        .status-authenticated {
            background: #f0fff4;
            color: #22543d;
        }
        .status-unauthenticated {
            background: #fed7d7;
            color: #742a2a;
        }
        .status-pending {
            background: #fef5e7;
            color: #744210;
        }
        .flow-diagram {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <h1>üéØ Central Auth Listener Test</h1>
    <p>Test the centralized authentication flow with proper email confirmation checks</p>

    <div class="test-section">
        <div class="test-title">üìä Current Auth Status</div>
        <div id="auth-status">
            <span>Session:</span> <span id="session-status" class="status-indicator status-pending">Loading...</span><br>
            <span>Email Confirmed:</span> <span id="email-status" class="status-indicator status-pending">Loading...</span><br>
            <span>Listener Initialized:</span> <span id="listener-status" class="status-indicator status-pending">Loading...</span>
        </div>
        <button class="test-button" onclick="updateAuthStatus()">Refresh Status</button>
    </div>

    <div class="test-section">
        <div class="test-title">üîó Google OAuth Test (No Manual Redirect)</div>
        <p>This button should ONLY call Supabase OAuth. All routing is handled by the central listener.</p>
        
        <div class="flow-diagram">
Expected Flow:
1. Click "Test Google OAuth" ‚Üí Only calls supabase.auth.signInWithOAuth()
2. Redirects to Google ‚Üí User authenticates
3. Google redirects to: https://yejheyrdsucgzpzwxuxs.supabase.co/auth/v1/callback
4. Supabase processes auth ‚Üí Redirects back to /auth.html
5. Central listener detects SIGNED_IN event
6. Central listener checks session.user.email_confirmed_at
7. If confirmed ‚Üí Central listener redirects to /dashboard.html
8. If not confirmed ‚Üí Shows verification message
        </div>
        
        <button class="test-button google" onclick="testGoogleOAuth()">Test Google OAuth</button>
        <button class="test-button" onclick="simulateSignOut()">Test Sign Out</button>
    </div>

    <div class="test-section">
        <div class="test-title">üõ£Ô∏è Route Protection Test</div>
        <p>Test how the central listener handles route protection</p>
        
        <button class="test-button" onclick="testDashboardAccess()">Try Access Dashboard</button>
        <button class="test-button" onclick="testAuthPageAccess()">Try Access Auth Page</button>
        <button class="test-button" onclick="testHomeAccess()">Try Access Home</button>
    </div>

    <div class="test-section">
        <div class="test-title">üìù Live Auth Logs</div>
        <button class="test-button" onclick="clearLogs()">Clear Logs</button>
        <div id="live-logs" class="log-output">Initializing central listener...\n</div>
    </div>

    <script type="module">
        import { handleGoogleLogin, handleSignOut } from './auth-handlers.js';
        import { authListener, getCurrentSession, isAuthenticated, isEmailConfirmed } from './auth-listener.js';

        // Capture console logs for display
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        
        function addToLogs(message, type = 'log') {
            const logsDiv = document.getElementById('live-logs');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '‚ùå' : type === 'warn' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logsDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToLogs(args.join(' '), 'log');
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToLogs(args.join(' '), 'error');
        };

        // Global functions for buttons
        window.updateAuthStatus = function() {
            const session = getCurrentSession();
            const authenticated = isAuthenticated();
            const emailConfirmed = isEmailConfirmed();
            
            document.getElementById('session-status').textContent = session ? 'Active' : 'None';
            document.getElementById('session-status').className = `status-indicator ${session ? 'status-authenticated' : 'status-unauthenticated'}`;
            
            document.getElementById('email-status').textContent = emailConfirmed ? 'Yes' : 'No';
            document.getElementById('email-status').className = `status-indicator ${emailConfirmed ? 'status-authenticated' : 'status-unauthenticated'}`;
            
            document.getElementById('listener-status').textContent = authListener.isInitialized ? 'Ready' : 'Loading';
            document.getElementById('listener-status').className = `status-indicator ${authListener.isInitialized ? 'status-authenticated' : 'status-pending'}`;
            
            console.log('üìä Status updated - Session:', !!session, 'Email confirmed:', emailConfirmed);
        };

        window.testGoogleOAuth = async function() {
            console.log('üß™ TEST: Starting Google OAuth test (no manual redirect)');
            
            try {
                const result = await handleGoogleLogin();
                
                if (result.error) {
                    throw result.error;
                }
                
                console.log('‚úÖ TEST: Google OAuth initiated successfully');
                console.log('üéØ TEST: Central listener will handle all routing from here');
                
            } catch (error) {
                console.error('‚ùå TEST: Google OAuth failed:', error.message);
            }
        };

        window.simulateSignOut = async function() {
            console.log('üß™ TEST: Starting sign out test');
            
            try {
                const result = await handleSignOut();
                
                if (result.error) {
                    throw result.error;
                }
                
                console.log('‚úÖ TEST: Sign out successful');
                
            } catch (error) {
                console.error('‚ùå TEST: Sign out failed:', error.message);
            }
        };

        window.testDashboardAccess = function() {
            console.log('üß™ TEST: Attempting to access dashboard');
            window.location.href = '/dashboard.html';
        };

        window.testAuthPageAccess = function() {
            console.log('üß™ TEST: Attempting to access auth page');
            window.location.href = '/auth.html';
        };

        window.testHomeAccess = function() {
            console.log('üß™ TEST: Attempting to access home page');
            window.location.href = '/';
        };

        window.clearLogs = function() {
            document.getElementById('live-logs').textContent = 'Logs cleared...\n';
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üß™ Central Listener Test Suite loaded');
            
            // Update status every 2 seconds
            setInterval(updateAuthStatus, 2000);
            updateAuthStatus();
        });
    </script>
</body>
</html>
