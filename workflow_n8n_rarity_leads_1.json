{
  "name": "Rarity Leads - Lead Ingestion & Enrichment",
  "nodes": [
    {
      "parameters": {},
      "name": "Start",
      "type": "n8n-nodes-base.start",
      "typeVersion": 1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "https://api.apollo.io/v1/mixed_people/search",
        "authentication": "headerAuth",
        "options": {
          "body": {
            "q_organization_domains": "saas",
            "person_locations": [
              "Brazil"
            ]
          }
        }
      },
      "name": "Fetch Leads from Apollo",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {
        "httpHeaderAuth": {
          "id": "YOUR_APOLLO_CREDENTIALS_ID",
          "name": "Apollo API"
        }
      }
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "name": "Loop Over Leads",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "https://<YOUR_SUPABASE_URL>.supabase.co/rest/v1/leads",
        "options": {
          "body": {
            "user_id": "={{ $json.body.user_id }}",
            "lead_name": "={{ $json.person.name }}",
            "role": "={{ $json.person.title }}",
            "email": "={{ $json.person.email }}",
            "phone": "={{ $json.person.phone_numbers[0] }}",
            "linkedin_url": "={{ $json.person.linkedin_url }}",
            "company_name": "={{ $json.organization.name }}",
            "industry": "={{ $json.organization.industry }}",
            "location": "={{ $json.person.city }}, {{ $json.person.state }}",
            "enrichment_data": "={{ $json }}"
          }
        },
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "<YOUR_SUPABASE_ANON_KEY>"
            },
            {
              "name": "Authorization",
              "value": "Bearer <YOUR_SUPABASE_SERVICE_ROLE_KEY>"
            },
            {
              "name": "Prefer",
              "value": "return=minimal"
            }
          ]
        }
      },
      "name": "Insert Lead into Supabase",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 300]
    }
  ],
  "connections": {
    "Start": {
      "main": [
        [
          {
            "node": "Fetch Leads from Apollo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Leads from Apollo": {
      "main": [
        [
          {
            "node": "Loop Over Leads",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop Over Leads": {
      "main": [
        [
          {
            "node": "Insert Lead into Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  }
}

{
  "name": "Rarity Leads - Phone Number Validation",
  "nodes": [
    {
      "parameters": {
        "path": "webhook/validate-phone",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "YOUR_WEBHOOK_ID"
    },
    {
      "parameters": {
        "url": "https://lookups.twilio.com/v2/PhoneNumbers/={{$json.body.phone}}?Fields=line_type_intelligence",
        "authentication": "predefinedCredential",
        "credentialType": "twilioApi",
        "options": {}
      },
      "name": "Validate with Twilio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {
        "twilioApi": {
          "id": "YOUR_TWILIO_CREDENTIALS_ID",
          "name": "Twilio Account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.valid}}",
              "value2": true
            }
          ]
        }
      },
      "name": "Is Valid?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "url": "https://<YOUR_SUPABASE_URL>.supabase.co/rest/v1/phone_numbers?phone_number=eq.{{$json.body.phone}}&user_id=eq.{{$json.body.user_id}}",
        "options": {
          "body": {
            "is_verified": true,
            "is_whatsapp_enabled": true
          }
        },
        "method": "PATCH",
        "headerParameters": {
          "parameters": [
             {
              "name": "apikey",
              "value": "<YOUR_SUPABASE_ANON_KEY>"
            },
            {
              "name": "Authorization",
              "value": "Bearer <YOUR_SUPABASE_SERVICE_ROLE_KEY>"
            }
          ]
        }
      },
      "name": "Update as WhatsApp Enabled",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 200]
    },
    {
      "parameters": {
        "url": "https://<YOUR_SUPABASE_URL>.supabase.co/rest/v1/phone_numbers?phone_number=eq.{{$json.body.phone}}&user_id=eq.{{$json.body.user_id}}",
        "options": {
          "body": {
            "is_verified": false
          }
        },
        "method": "PATCH",
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "<YOUR_SUPABASE_ANON_KEY>"
            },
            {
              "name": "Authorization",
              "value": "Bearer <YOUR_SUPABASE_SERVICE_ROLE_KEY>"
            }
          ]
        }
      },
      "name": "Update as Invalid",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 400]
    }
  ],
  "connections": {
    "Webhook Trigger": {"main": [[{"node": "Validate with Twilio","type": "main","index": 0}]]},
    "Validate with Twilio": {"main": [[{"node": "Is Valid?","type": "main","index": 0}]]},
    "Is Valid?": {
      "main": [
        [{"node": "Update as WhatsApp Enabled","type": "main","index": 0}],
        [{"node": "Update as Invalid","type": "main","index": 0}]
      ]
    }
  }
}

{
  "name": "Rarity Leads - AI Follow-Up Message",
  "nodes": [
    {
      "parameters": {
        "path": "webhook/send-message",
        "options": {}
      },
      "name": "Webhook Trigger",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 1,
      "position": [250, 300],
      "webhookId": "YOUR_OTHER_WEBHOOK_ID"
    },
    {
      "parameters": {
        "operation": "select",
        "schema": "public",
        "table": "leads",
        "filters": {
          "filters": [
            {
              "field": "id",
              "operator": "eq",
              "value": "={{ $json.body.lead_id }}"
            }
          ]
        }
      },
      "name": "Fetch Lead Data",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [450, 300],
      "credentials": {
        "supabaseApi": {
          "id": "YOUR_SUPABASE_CREDENTIALS_ID",
          "name": "Supabase Account"
        }
      }
    },
    {
      "parameters": {
        "model": "gpt-4",
        "prompt": "Você é um SDR de alta performance. Escreva uma mensagem curta e personalizada para iniciar uma conversa com {{$json.lead_name}}, que é {{$json.role}} na {{$json.company_name}}. Mencione que você atua no setor de {{$json.industry}}. O objetivo é apenas iniciar uma conversa, não vender nada ainda."
      },
      "name": "Generate Message with OpenAI",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [650, 300],
      "credentials": {
        "openAiApi": {
          "id": "YOUR_OPENAI_CREDENTIALS_ID",
          "name": "OpenAI Account"
        }
      }
    },
    {
      "parameters": {
        "url": "https://graph.facebook.com/v18.0/<YOUR_PHONE_NUMBER_ID>/messages",
        "authentication": "bearer",
        "options": {
          "body": {
            "messaging_product": "whatsapp",
            "to": "={{ $json.phone }}",
            "type": "text",
            "text": {
                "body": "{{ $last.json.choices[0].message.content }}"
            }
          }
        }
      },
      "name": "Send WhatsApp Message",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 1,
      "position": [850, 300],
       "credentials": {
        "httpBearerAuth": {
          "id": "YOUR_WHATSAPP_CREDENTIALS_ID",
          "name": "WhatsApp API"
        }
      }
    },
    {
      "parameters": {
        "operation": "update",
        "schema": "public",
        "table": "leads",
        "filters": { "filters": [{"field": "id", "operator": "eq", "value": "={{ $json.body.lead_id }}" }]},
        "columns": { "columns": [{"name": "lead_status", "value": "engaged"}]}
      },
      "name": "Update Lead Status",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [1050, 300],
      "credentials": {
        "supabaseApi": { "id": "YOUR_SUPABASE_CREDENTIALS_ID", "name": "Supabase Account" }
      }
    }
  ],
  "connections": {
    "Webhook Trigger": { "main": [[{ "node": "Fetch Lead Data", "type": "main", "index": 0 }]]},
    "Fetch Lead Data": { "main": [[{ "node": "Generate Message with OpenAI", "type": "main", "index": 0 }]]},
    "Generate Message with OpenAI": { "main": [[{ "node": "Send WhatsApp Message", "type": "main", "index": 0 }]]},
    "Send WhatsApp Message": { "main": [[{ "node": "Update Lead Status", "type": "main", "index": 0 }]]}
  }
}
